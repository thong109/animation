<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./assets/css/style3.css" />
  </head>

  <body>
    <div class="container">
      <nav>
        <a href="">abc</a>
        <div class="nav-items">
          <a href="">abc</a>
          <a href="">abc</a>
          <a href="">abc</a>
        </div>
      </nav>
      <section class="intro">
        <h1>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Quidem ad,
          repudiandae odit hic, animi doloribus tenetur maiores a nulla beatae
          totam quasi esse necessitatibus. Excepturi recusandae doloremque
          repellendus provident enim.
        </h1>
      </section>

      <section class="sticky-slider">
        <div class="slide-images">
          <div class="img" id="img-1">
            <img src="./assets/img/img-slide-1.png" alt="" />
          </div>
        </div>

        <div class="slide-info">
          <div class="slide-title-prefix">
            <p>Essence</p>
          </div>

          <div class="slide-title">
            <p id="title-text">Anime</p>
          </div>
          <div class="slide-link">
            <a href="">View more &#8599;</a>
          </div>
        </div>
      </section>

      <section class="outro">
        <h1>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Soluta,
          dignissimos esse laboriosam voluptatem mollitia aperiam nisi minus
          ipsam non dolores similique sint hic nemo. Quos animi error quia neque
          quibusdam.
        </h1>
      </section>
    </div>

    <script src="https://unpkg.com/lenis@1.3.0/dist/lenis.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.7/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.7/dist/ScrollTrigger.min.js"></script>
    <script>
      const slides = [
        {
          title: "Slide 1 Title",
          image: "./assets/img/img-slide-1.png",
          url: "https://example.com/slide1",
        },
        {
          title: "Slide 2 Title",
          image: "./assets/img/img-slide-2.png",
          url: "https://example.com/slide2",
        },
        {
          title: "Slide 3 Title",
          image: "./assets/img/img-slide-3.png",
          url: "https://example.com/slide3",
        },
        {
          title: "Slide 4 Title",
          image: "./assets/img/img-slide-4.png",
          url: "https://example.com/slide4",
        },
        {
          title: "Slide 5 Title",
          image: "./assets/img/img-slide-5.png",
          url: "https://example.com/slide5",
        },
        {
          title: "Slide 6 Title",
          image: "./assets/img/img-slide-6.png",
          url: "https://example.com/slide6",
        },
        {
          title: "Slide 7 Title",
          image: "./assets/img/img-slide-7.png",
          url: "https://example.com/slide7",
        },
      ];

      gsap.registerPlugin(ScrollTrigger);
      document.addEventListener("DOMContentLoaded", () => {
        const lenis = new Lenis();
        lenis.on("scroll", ScrollTrigger.update);
        gsap.ticker.add((time) => lenis.raf(time * 1000));
        gsap.ticker.lagSmoothing(0);

        const slideImages = document.querySelector(".slide-images");
        const titleElement = document.getElementById("title-text");
        const exploreLink = document.querySelector(".slide-link a");

        const totalSlides = slides.length;
        const stripCount = 25;
        let currentTitleIndex = 0;
        let queuedTitleIndex = null;
        const titleChangeThreshold = 0.5;
        let isAnimating = false;

        const firstSlideImg = document.querySelector("#img-1 img");
        firstSlideImg.style.transform = "scale(1.25)";

        for (let i = 1; i < totalSlides; i++) {
          const imgContainer = document.createElement("div");
          imgContainer.className = "img-container";
          imgContainer.id = `img-container-${i + 1}`;
          imgContainer.style.opacity = "0";

          for (let j = 0; j < stripCount; j++) {
            const strip = document.createElement("div");
            strip.className = "strip";

            const img = document.createElement("img");
            img.src = slides[i].image;
            img.alt = slides[i].title;
            img.style.transform = "scale(1.25)";

            const stripPosFromBottom = stripCount - j - 1;
            const lower = (stripPosFromBottom + 1) * (100 / stripCount);
            const upper = stripPosFromBottom * (100 / stripCount);

            strip.style.clipPath = `polygon(0 ${lower.toFixed(
              2
            )}%, 100% ${lower.toFixed(2)}%, 100% ${(lower - 0.1).toFixed(
              2
            )}%, 0 ${(lower - 0.1).toFixed(2)}%)`;

            strip.appendChild(img);
            imgContainer.appendChild(strip);
          }

          slideImages.appendChild(imgContainer);
        }

        const transitionCount = totalSlides - 1;
        const scrollDistancePerTransition = 1000;
        const initialScrollDelay = 300;
        const finalScrollDelay = 300;
        const totalScrollDistance =
          transitionCount * scrollDistancePerTransition +
          initialScrollDelay +
          finalScrollDelay;

        const transitionRanges = [];
        let currentScrollPosition = initialScrollDelay;

        for (let i = 0; i < transitionCount; i++) {
          const transitionStart = currentScrollPosition;
          const transitionEnd = transitionStart + scrollDistancePerTransition;

          transitionRanges.push({
            transition: i,
            startVh: transitionStart,
            endVh: transitionEnd,
            startPercent: transitionStart / totalScrollDistance,
            endPercent: transitionEnd / totalScrollDistance,
          });

          currentScrollPosition = transitionEnd;
        }

        function calculateImagePosition(scrollProgress) {
          if (scrollProgress <= transitionRanges[0].startPercent) return 0;
          if (
            scrollProgress >=
            transitionRanges[transitionRanges.length - 1].endPercent
          )
            return transitionRanges.length;

          for (let i = 0; i < transitionRanges.length; i++) {
            const range = transitionRanges[i];
            if (
              scrollProgress >= range.startPercent &&
              scrollProgress <= range.endPercent
            ) {
              const normalized =
                (scrollProgress - range.startPercent) /
                (range.endPercent - range.startPercent);
              return i + normalized;
            }
          }

          return 0;
        }

        function getScaleForImage(imageIndex, currentImageIndex, progress) {
          if (imageIndex > currentImageIndex) return 1.25;
          if (imageIndex < currentImageIndex - 1) return 1;

          const totalProgress =
            imageIndex === currentImageIndex ? progress : 1 + progress;
          return 1.25 - (0.25 * totalProgress) / 2;
        }

        function animateTitleChange(index, direction) {
          if (index === currentTitleIndex || isAnimating) {
            queuedTitleIndex = index;
            return;
          }

          isAnimating = true;
          const newTitle = slides[index].title;
          const newUrl = slides[index].url;
          const outY = direction === "down" ? "-120%" : "120%";
          const inY = direction === "down" ? "120%" : "-120%";

          gsap.to(titleElement, {
            y: outY,
            duration: 0.5,
            ease: "power3.out",
            onComplete: () => {
              titleElement.textContent = newTitle;
              exploreLink.href = newUrl;
              gsap.set(titleElement, { y: inY });

              gsap.to(titleElement, {
                y: "0%",
                duration: 0.5,
                ease: "power3.out",
                onComplete: () => {
                  currentTitleIndex = index;
                  isAnimating = false;

                  if (queuedTitleIndex !== null && queuedTitleIndex !== index) {
                    const nextIndex = queuedTitleIndex;
                    queuedTitleIndex = null;
                    animateTitleChange(nextIndex, direction);
                  }
                },
              });
            },
          });
        }

        function getTitleIndexForProgress(imageProgress) {
          const imageIndex = Math.floor(imageProgress);
          const imageSpecificProgress = imageProgress - imageIndex;
          return imageSpecificProgress >= titleChangeThreshold
            ? Math.min(imageIndex + 1, slides.length - 1)
            : imageIndex;
        }

        let lastImageProgress = 0;

        ScrollTrigger.create({
          trigger: ".sticky-slider",
          start: "top top",
          end: `+=${totalScrollDistance}vh`,
          pin: true,
          pinSpacing: true,
          scrub: 1,
          invalidateOnRefresh: true,
          onUpdate: (self) => {
            const imageProgress = calculateImagePosition(self.progress);
            const scrollDirection =
              imageProgress > lastImageProgress ? "down" : "up";
            const currentImageIndex = Math.floor(imageProgress);
            const imageSpecificProgress = imageProgress - currentImageIndex;

            const correctTitleIndex = getTitleIndexForProgress(imageProgress);
            if (correctTitleIndex !== currentTitleIndex && !isAnimating) {
              animateTitleChange(correctTitleIndex, scrollDirection);
            }

            const firstScale = getScaleForImage(
              0,
              currentImageIndex,
              imageSpecificProgress
            );
            firstSlideImg.style.transform = `scale(${firstScale})`;

            for (let i = 1; i < totalSlides; i++) {
              const container = document.getElementById(
                `img-container-${i + 1}`
              );
              if (!container) continue;

              container.style.opacity = "1";
              const strips = container.querySelectorAll(".strip");
              const images = container.querySelectorAll("img");
              const transitionIndex = i - 1;

              if (transitionIndex < currentImageIndex) {
                strips.forEach((strip, j) => {
                  const pos = stripCount - j - 1;
                  const lower = (pos + 1) * (100 / stripCount);
                  strip.style.clipPath = `polygon(0 ${lower.toFixed(
                    2
                  )}%, 100% ${lower.toFixed(2)}%, 100% ${(lower - 0.1).toFixed(
                    2
                  )}%, 0 ${(lower - 0.1).toFixed(2)}%)`;
                });
              } else if (transitionIndex === currentImageIndex) {
                strips.forEach((strip, j) => {
                  const pos = stripCount - j - 1;
                  const lower = (pos + 1) * (100 / stripCount);
                  const upper = pos * (100 / stripCount);
                  const delay = (j / stripCount) * 0.5;
                  const adjustedProgress = Math.max(
                    0,
                    Math.min(1, (imageSpecificProgress - delay) * 2)
                  );
                  const currentUpper =
                    lower - (lower - (upper - 0.1)) * adjustedProgress;
                  strip.style.clipPath = `polygon(0 ${lower.toFixed(
                    2
                  )}%, 100% ${lower.toFixed(2)}%, 100% ${currentUpper.toFixed(
                    2
                  )}%, 0 ${currentUpper.toFixed(2)}%)`;
                });
              } else {
                strips.forEach((strip, j) => {
                  const pos = stripCount - j - 1;
                  const lower = (pos + 1) * (100 / stripCount);
                  strip.style.clipPath = `polygon(0 ${lower.toFixed(
                    2
                  )}%, 100% ${lower.toFixed(2)}%, 100% ${lower.toFixed(
                    2
                  )}%, 0 ${lower.toFixed(2)}%)`;
                });
              }

              const scale = getScaleForImage(
                transitionIndex,
                currentImageIndex,
                imageSpecificProgress
              );
              images.forEach((img) => {
                img.style.transform = `scale(${scale})`;
              });
            }

            lastImageProgress = imageProgress;
          },
        });
      });
    </script>
  </body>
</html>
